#!/bin/bash

SRC_VERSION="3.82"
SRC_FILENAME="make-$SRC_VERSION.tgz"
SRC_FETCH_PATH="http://ftp.gnu.org/gnu/make/make-$SRC_VERSION.tar.gz"
SRC_FETCH_METHOD="http"
PATCHES=( 
    make-3.82-bug30723.patch
    make-3.82-bug30748.patch 
    make-3.82-bug31743.patch 
)

if [[ ! -e ../$SRC_FILENAME ]] ; then
    echo "## downloading $SRC_FETCH_PATH" >&2
    if ! curl -L -s -o "../$SRC_FILENAME" "$SRC_FETCH_PATH" ; then
        die "can't read or download $SRC_FILENAME"
    fi
fi

echo "## extracting $SRC_FILENAME in $BUILDDIR" >&2
tar zxf ../$SRC_FILENAME --strip-components 1

for patch in ${PATCHES[@]} ; do
  echo "## patching with $PDIR/$patch" >&2
  patch -p1 < $PDIR/$patch
done

./configure --prefix="/usr" --sysconfdir="/etc"
make
strip make

if [[ -d $DESTDIR ]] ; then
    cp make $DESTDIR/$PKG
else
    echo "re-run with --install to install binaries" >&2
fi

